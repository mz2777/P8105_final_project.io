---
title: "Statistical Analysis"

output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include = FALSE}
library(tidyverse)
library(rnoaa)
library(viridis)
library(broom)
library(knitr)
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
theme_set(theme_minimal() + theme(legend.position = "bottom"))
```

```{r, message = FALSE, warning = FALSE}
## load data
fire = read_csv("./final_report/data/fire_0515.csv")

state.abb = append(state.abb, c("DC", "PR"))
state.name = append(state.name, c("District of Columbia", "Puerto Rico"))

tidy_fire = 
  fire %>% 
  separate(cont_time, into = c("cont_hour","cont_min") ,sep = 2) %>% 
  separate(discovery_time, into = c("disc_hour","disc_min") ,sep = 2) %>% 
  mutate(cont_hour = as.numeric(cont_hour),
         cont_min = as.numeric(cont_min),
         disc_hour = as.numeric(disc_hour),
         disc_min = as.numeric(disc_min)) %>% 
  # change julian days
  mutate(discovery_date = as.Date(discovery_date - 2458014.5, origin = '2017-09-18'),
         cont_date = as.Date(cont_date - 2458014.5, origin = '2017-09-18'),
         duration_day = as.numeric(difftime(cont_date, discovery_date, units = "days"))) %>% 
  mutate(
    duration_hour = cont_hour - disc_hour,
    duration_min = cont_min - disc_min,
    duration = duration_day * 24 + duration_hour + duration_min / 60
  ) %>% 
  select(-duration_day, -duration_hour,-duration_min) %>% 
  mutate(fips_name = tolower(fips_name),
         fire_size_class = fct_inorder(fire_size_class),
         region = state.name[match(state, state.abb)],
         cause = as.factor(stat_cause_descr),
         cause = relevel(cause, ref = "Missing/Undefined")) ## change reference level to "missing/undefined" for later linear models
```

## Association between duration and size of fire

As stated previously, we noticed a trend of increased size with accumulated fire existing time. We proposed a linear model where duration and causes of fire would be associated with size of fire. There is a significant (p-value < 0.001) association between duration of a fire and its size. For every hour increase in duration, the affect area would increase by 1.839 acres. In addition, certain causes will affect size of fire. There is a strong association between fires caused by lightening and increased size (p-value < 0.001). Compared to fires with missing or undefined causes, fires caused by strikes would affect 194.633 acres more on average under the same duration.

```{r}
## linear model between size, duration and cause
model_1 = lm(fire_size ~ duration + cause, data = tidy_fire)
model_1 %>% 
  tidy() %>% 
  kable(digits = 3,
        caption = "Association between duration and causes and size of fire")
```

## Association between temperature and the number of fires

We are also interested to know whether there would be more fires when temperature was higher. We retrieved daily weather data using `rnoaa` package at county level. We have limited analysis to two counties with the most fires in 2015 in states where fires happened most frequently during these 10 years (California and Texas according to previous analysis): Riverside(CA) and Dallas(TX).

```{r, message = FALSE, warning = FALSE}
## subset the dataset to only include data from 2015 in TX and CA
fire_15 = tidy_fire %>% 
  filter(state == "CA" | state == "TX") %>% 
  filter(fire_year == 2015) %>% 
  drop_na(fips_code, fips_name) %>% 
  mutate(county = fips_name)
  
## find top 1 county in each state with the most fires in 2015
fire_15 %>% 
  group_by(region, county) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  group_by(region) %>% 
  mutate(rank = rank(-count)) %>% 
  filter(rank == 1) %>% 
  select(-rank) %>% 
  kable(caption = "Counties with the most count of fires in 2015")

## subset further to focus on the above two counties
fire_15 = fire_15 %>% 
  filter(county == "riverside" | county == "dallas") %>% 
  mutate(date = discovery_date)

## get a list of stations in rnoaa
stations = ghcnd_stations()

## get station id in "riverside" and "dallas"
station_id = stations %>% 
  mutate(name = tolower(name)) %>% 
  filter(state == "CA" | state == "TX") %>% 
  filter(str_detect(name, c("riverside", "dallas")),
         last_year == 2019, 
         element == "TMAX") %>% 
  pull(id)

## retrieve weather data in each station between 2005 and 2015
weather_15 = meteo_pull_monitors(station_id,
                                  date_min = "2005-01-01", 
                                  date_max = "2015-12-31",
                                  var = c("PRCP", "TMAX", "TMIN")) %>% 
  mutate(tmax = tmax / 10,
         tmin = tmin / 10,
         tmean = (tmax + tmin) / 2,
         county = recode(id, 
                            "USW00003171" = "riverside",
                            "USW00013960" = "dallas"))

## join the weather data with cleaned dataset (2015)
fire_15_weather = left_join(fire_15, weather_15, by = c("date", "county"))
```

### Visualization

* Distribution of daily mean temperature and count of fires in 2015

The below graph illustrates distribution of daily mean temperature and number of fires per day in 2015. Since temperature distribution is similar between different year, we selected one year (2015) for visualization. The points above represents daily mean temperature which roughly follows a bell-shape curve. The histogram below shows the number of fires per day. Both variables showed a similar pattern of distribution. In addition, precipitation is unlikely to be associated with number of fires with such insufficient data.

```{r, message = FALSE}
p1 = fire_15_weather %>% 
  ggplot(aes(x = date)) +
  geom_histogram(aes(fill = county), alpha = .8, show.legend = FALSE) +
  geom_point(aes(y = tmean * 5, size = prcp, color = county), alpha = .6) +
  geom_smooth(aes(y = tmean * 5, color = county), 
              method = "loess", se = FALSE, alpha = .7, size = .8) +
  scale_y_continuous(sec.axis = sec_axis(~./5, name = "Mean temperature (°C)")) +
  labs(title = "Fig 1. Distribution of mean temperature and number of fires in 2015",
       x = "Date",
       y = "Number of fires",
       color = "County",
       size = "Precipitation")
  
p1
```

### Linear Regression

We build a linear regression model with number of fires per month and mean monthly temperature. There is a significant association (p-value < 0.001) between the two. For every 1°C increase in monthly mean temperature, the total number of fires per month will increase by 3.820 on average.

```{r}
## form a new dataset of count of fires in "riverside" and "dallas"
fire_rd = tidy_fire %>% 
  mutate(county = fips_name) %>% 
  filter(state == "CA" | state == "TX") %>% 
  filter(county == "riverside" | county == "dallas") %>% 
  mutate(date = discovery_date) %>% 
  group_by(date, county) %>% 
  summarise(n = n())

## join the count dataset with weather information
fire_rd_count = left_join(fire_rd, weather_15, by = c("date", "county"))

## calculate monthly number of fires and mean temperature
fire_rd_m = fire_rd_count %>% 
  separate(date, into = c("year", "month", "day"), sep = "-") %>% 
  group_by(year, month) %>% 
  summarise(count = sum(n),
            tmean = mean(tmean),
            prcp = mean(prcp))

## linear regression
model_2 = lm(count ~ tmean, data = fire_rd_m)
model_2 %>% 
  tidy() %>% 
  kable(digits = 3, caption = "Association between number of fires and mean temperature")
```
